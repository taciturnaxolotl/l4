<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>l4 - image cache</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>⚡</text></svg>">
    <style>
        :root {
            --evergreen: #16302b;
            --vintage-grape: #694873;
            --dusty-mauve: #8b728e;
            --muted-teal: #85b79d;
            --tea-green: #c0e5c8;
            --evergreen-dark: #0d1f1b;
            --input-bg: #1a3530;
            --border-color: #2a4540;
            --hover-bg: #243d38;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            background: var(--evergreen);
        }

        body {
            font-family: "Courier New", monospace;
            background: var(--evergreen);
            color: var(--tea-green);
            min-height: 100vh;
            padding: 2.5rem 1.25rem;
            display: flex;
            flex-direction: column;
        }

        main {
            max-width: 56.25rem;
            margin: 0 auto;
            flex: 1;
            width: 100%;
        }

        header {
            margin-bottom: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        h1 {
            font-size: 2.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--muted-teal), var(--tea-green));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: -0.0625rem;
        }

        .user-info {
            display: flex;
            gap: 0.75rem;
            align-items: center;
            color: var(--muted-teal);
            font-size: 0.875rem;
        }

        .shortcut {
            color: var(--muted-teal);
            font-size: 0.6875rem;
            margin-bottom: 1rem;
        }

        .shortcut kbd {
            background: var(--input-bg);
            padding: 0.125rem 0.375rem;
            border: 0.0625rem solid var(--border-color);
            font-size: 0.6875rem;
            font-family: monospace;
        }

        .tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            border-bottom: 0.0625rem solid var(--border-color);
        }

        .tab {
            padding: 0.5rem 1rem;
            background: transparent;
            border: none;
            color: var(--muted-teal);
            cursor: pointer;
            font-family: "Courier New", monospace;
            font-size: 0.875rem;
            border-bottom: 0.125rem solid transparent;
            margin-bottom: -0.0625rem;
            transition: all 0.15s;
        }

        .tab:hover {
            color: var(--tea-green);
        }

        .tab:focus {
            outline: 0.0625rem solid var(--tea-green);
            outline-offset: 0;
        }

        .tab.active {
            color: var(--tea-green);
            border-bottom-color: var(--tea-green);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .upload-section {
            background: var(--input-bg);
            border: 0.125rem dashed var(--border-color);
            padding: 2rem;
            margin-bottom: 1.5rem;
            text-align: center;
            transition: border-color 0.15s;
        }

        .upload-section:hover,
        .upload-section.dragover {
            border-color: var(--muted-teal);
        }

        .upload-section h2 {
            font-size: 1.125rem;
            margin-bottom: 0.5rem;
            font-weight: 700;
        }

        .upload-section p {
            color: var(--muted-teal);
            font-size: 0.8125rem;
            margin-bottom: 1rem;
        }

        input[type="file"] {
            display: none;
        }

        .file-label {
            display: inline-block;
            padding: 0.75rem 1.5rem;
            background: var(--vintage-grape);
            color: var(--tea-green);
            cursor: pointer;
            font-family: "Courier New", monospace;
            font-size: 0.875rem;
            font-weight: 700;
            transition: background 0.15s;
        }

        .file-label:hover {
            background: var(--dusty-mauve);
        }

        button {
            padding: 0.5rem 1rem;
            background: var(--vintage-grape);
            color: var(--tea-green);
            border: none;
            font-size: 0.875rem;
            font-weight: 700;
            cursor: pointer;
            font-family: "Courier New", monospace;
            transition: background 0.15s;
        }

        button:hover {
            background: var(--dusty-mauve);
        }

        button:focus {
            outline: 0.0625rem solid var(--tea-green);
            outline-offset: 0;
        }

        button.danger {
            background: #8b2828;
            color: #ffb3b3;
        }

        button.danger:hover {
            background: #a03030;
        }

        .status-bar {
            background: var(--vintage-grape);
            color: var(--tea-green);
            padding: 0.75rem;
            margin-bottom: 1rem;
            font-size: 0.875rem;
            display: none;
        }

        .status-bar.show {
            display: block;
        }

        .images-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 1rem;
        }

        .image-card {
            background: var(--input-bg);
            border: 0.0625rem solid var(--border-color);
            overflow: hidden;
            transition: border-color 0.15s;
        }

        .image-card:hover {
            border-color: var(--muted-teal);
        }

        .image-card:focus-within {
            border-color: var(--tea-green);
        }

        .image-preview {
            width: 100%;
            height: 180px;
            object-fit: cover;
            background: var(--evergreen-dark);
            display: block;
        }

        .image-info {
            padding: 0.75rem;
        }

        .image-url {
            font-size: 0.75rem;
            color: var(--muted-teal);
            word-break: break-all;
            margin-bottom: 0.5rem;
        }

        .image-actions {
            display: flex;
            gap: 0.5rem;
        }

        .image-actions button {
            flex: 1;
            padding: 0.5rem;
            font-size: 0.75rem;
        }

        .api-keys-list {
            background: var(--input-bg);
            border: 0.0625rem solid var(--border-color);
        }

        .api-key-item {
            padding: 1rem;
            border-bottom: 0.0625rem solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.15s;
        }

        .api-key-item:hover {
            background: var(--hover-bg);
        }

        .api-key-item:last-child {
            border-bottom: none;
        }

        .api-key-item:focus-within {
            border-left: 0.125rem solid var(--tea-green);
            padding-left: calc(1rem - 0.0625rem);
        }

        .api-key-info h3 {
            font-size: 0.9375rem;
            margin-bottom: 0.25rem;
            font-weight: 700;
        }

        .api-key-meta {
            font-size: 0.75rem;
            color: var(--muted-teal);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(13, 31, 27, 0.9);
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--evergreen);
            border: 0.0625rem solid var(--border-color);
            padding: 2rem;
            max-width: 500px;
            width: 90%;
        }

        .modal-content h2 {
            margin-bottom: 1.5rem;
            font-size: 1.5rem;
            font-weight: 700;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--muted-teal);
            font-size: 0.875rem;
        }

        .form-group input {
            width: 100%;
            padding: 0.75rem;
            background: var(--input-bg);
            border: 0.0625rem solid var(--border-color);
            color: var(--tea-green);
            font-size: 0.875rem;
            font-family: "Courier New", monospace;
            transition: border-color 0.15s;
        }

        .form-group input:focus {
            outline: none;
            border-color: var(--tea-green);
        }

        .form-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 1.5rem;
        }

        .form-actions button {
            flex: 1;
        }

        .loading {
            text-align: center;
            padding: 2rem;
            color: var(--muted-teal);
            font-size: 0.875rem;
        }

        footer {
            margin-top: 2rem;
            padding-top: 1rem;
            border-top: 0.0625rem solid var(--border-color);
            text-align: center;
            color: var(--muted-teal);
            font-size: 0.75rem;
        }
    </style>
</head>
<body>
    <main>
        <header>
            <div>
                <h1>l4</h1>
            </div>
            <div class="user-info">
                <span id="userName"></span>
                <button onclick="logout()">logout</button>
            </div>
        </header>

        <div class="shortcut">
            keyboard shortcuts: <kbd>1</kbd> images <kbd>2</kbd> api keys <kbd>u</kbd> upload <kbd>esc</kbd> close modal
        </div>

        <div class="status-bar" id="statusBar"></div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('images')" data-key="1">images</button>
            <button class="tab" onclick="switchTab('api-keys')" data-key="2">api keys</button>
        </div>

        <div id="images-tab" class="tab-content active">
            <div class="upload-section" id="uploadSection">
                <h2>upload image</h2>
                <p>drag and drop or click to upload</p>
                <input type="file" id="fileInput" accept="image/*">
                <label for="fileInput" class="file-label">choose file</label>
            </div>

            <div class="images-grid" id="imagesGrid"></div>
        </div>

        <div id="api-keys-tab" class="tab-content">
            <div style="margin-bottom: 1rem;">
                <button onclick="showCreateKeyModal()">create api key</button>
            </div>
            <div class="api-keys-list" id="apiKeysList"></div>
        </div>
    </main>

    <footer>
        powered by cloudflare r2 • zero egress costs
    </footer>

    <div class="modal" id="createKeyModal">
        <div class="modal-content">
            <h2>create api key</h2>
            <div class="form-group">
                <label>key name</label>
                <input type="text" id="keyName" placeholder="my cli key" autofocus>
            </div>
            <div class="form-group">
                <label>expires in (days)</label>
                <input type="number" id="keyExpiry" placeholder="30">
            </div>
            <div class="form-actions">
                <button onclick="closeModal()">cancel</button>
                <button onclick="createApiKey()">create</button>
            </div>
        </div>
    </div>

    <div class="modal" id="keyCreatedModal">
        <div class="modal-content">
            <h2>api key created</h2>
            <p style="margin-bottom: 1rem; color: var(--muted-teal);">save this key - you won't see it again</p>
            <div class="form-group">
                <input type="text" id="newApiKey" readonly>
            </div>
            <div class="form-actions">
                <button onclick="copyApiKey()">copy</button>
                <button onclick="closeKeyCreatedModal()">done</button>
            </div>
        </div>
    </div>

    <script>
        let token = null;
        let userRole = null;

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            // Don't trigger if typing in input
            if (e.target.tagName === 'INPUT') return;

            // Tab switching
            if (e.key === '1') {
                e.preventDefault();
                switchTab('images');
                document.querySelector('.tab[data-key="1"]').focus();
            }
            if (e.key === '2' && userRole === 'admin') {
                e.preventDefault();
                switchTab('api-keys');
                document.querySelector('.tab[data-key="2"]').focus();
            }

            // Upload shortcut (admin only)
            if ((e.key === 'u' || e.key === 'U') && userRole === 'admin') {
                e.preventDefault();
                document.getElementById('fileInput').click();
            }

            // Close modal
            if (e.key === 'Escape') {
                closeModal();
                closeKeyCreatedModal();
            }

            // Create key (admin only)
            if (e.key === 'c' && userRole === 'admin' && document.getElementById('api-keys-tab').classList.contains('active')) {
                e.preventDefault();
                showCreateKeyModal();
            }
        });

        function showStatus(message, duration = 3000) {
            const bar = document.getElementById('statusBar');
            bar.textContent = message;
            bar.classList.add('show');
            setTimeout(() => bar.classList.remove('show'), duration);
        }

        async function init() {
            const params = new URLSearchParams(window.location.search);
            token = params.get('token') || localStorage.getItem('l4_token');

            if (!token) {
                window.location.href = '/login';
                return;
            }

            localStorage.setItem('l4_token', token);
            window.history.replaceState({}, '', '/');

            try {
                const response = await fetch('/api/me', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) {
                    throw new Error('Unauthorized');
                }

                const user = await response.json();
                userRole = user.role;
                document.getElementById('userName').textContent = user.profile?.name || 'user';

                // Hide admin-only elements for viewers
                if (userRole === 'viewer') {
                    document.getElementById('uploadSection').style.display = 'none';
                    document.querySelector('.tab[data-key="2"]').style.display = 'none';
                    document.querySelector('.shortcut').style.display = 'none';
                }

                await loadImages();
                if (userRole === 'admin') {
                    await loadApiKeys();
                }
            } catch (error) {
                localStorage.removeItem('l4_token');
                window.location.href = '/login';
            }
        }

        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            const activeTab = document.querySelector(`.tab[onclick*="${tab}"]`);
            if (activeTab) activeTab.classList.add('active');
            
            const content = document.getElementById(`${tab}-tab`);
            if (content) content.classList.add('active');

            if (tab === 'api-keys') {
                loadApiKeys();
            }
        }

        const uploadSection = document.getElementById('uploadSection');
        const fileInput = document.getElementById('fileInput');

        uploadSection.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadSection.classList.add('dragover');
        });

        uploadSection.addEventListener('dragleave', () => {
            uploadSection.classList.remove('dragover');
        });

        uploadSection.addEventListener('drop', async (e) => {
            e.preventDefault();
            uploadSection.classList.remove('dragover');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                await uploadFile(files[0]);
            }
        });

        fileInput.addEventListener('change', async (e) => {
            if (e.target.files.length > 0) {
                await uploadFile(e.target.files[0]);
            }
        });

        async function uploadFile(file) {
            const formData = new FormData();
            formData.append('file', file);

            try {
                const response = await fetch('/api/upload', {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` },
                    body: formData
                });

                if (!response.ok) {
                    throw new Error('upload failed');
                }

                const result = await response.json();
                const imageUrl = window.location.origin + '/i/' + result.key;
                
                navigator.clipboard.writeText(imageUrl);
                showStatus('image uploaded • url copied');
                await loadImages();
                fileInput.value = '';
            } catch (error) {
                showStatus('upload failed');
            }
        }

        async function loadImages() {
            const grid = document.getElementById('imagesGrid');
            grid.innerHTML = '<div class="loading">loading...</div>';

            try {
                const response = await fetch('/api/images', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) {
                    throw new Error('failed to load images');
                }

                const data = await response.json();
                
                if (data.images.length === 0) {
                    grid.innerHTML = '<div class="loading">no images</div>';
                    return;
                }

                grid.innerHTML = data.images.map(img => `
                    <div class="image-card" tabindex="0">
                        <img src="/i/${img.key}?w=400&f=webp" alt="${img.originalName}" class="image-preview">
                        <div class="image-info">
                            <div class="image-url">/i/${img.key}</div>
                            <div class="image-actions">
                                <button onclick="copyUrl('/i/${img.key}')">copy</button>
                                ${userRole === 'admin' ? `<button class="danger" onclick="deleteImage('${img.key}')">delete</button>` : ''}
                            </div>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                grid.innerHTML = '<div class="loading">failed to load</div>';
            }
        }

        function copyUrl(path) {
            const url = window.location.origin + path;
            navigator.clipboard.writeText(url);
            showStatus('copied');
        }

        async function deleteImage(key) {
            if (!confirm('delete this image?')) return;

            try {
                const response = await fetch(`/api/images/${key}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    showStatus('deleted');
                    await loadImages();
                }
            } catch (error) {
                showStatus('delete failed');
            }
        }

        async function loadApiKeys() {
            const list = document.getElementById('apiKeysList');
            list.innerHTML = '<div class="loading">loading...</div>';

            try {
                const response = await fetch('/api/keys', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) {
                    throw new Error('failed to load api keys');
                }

                const data = await response.json();

                if (data.keys.length === 0) {
                    list.innerHTML = '<div class="loading">no api keys</div>';
                    return;
                }

                list.innerHTML = data.keys.map(key => {
                    const created = new Date(key.createdAt).toLocaleDateString();
                    const expires = key.expiresAt ? new Date(key.expiresAt).toLocaleDateString() : 'never';
                    
                    return `
                        <div class="api-key-item" tabindex="0">
                            <div class="api-key-info">
                                <h3>${key.name}</h3>
                                <div class="api-key-meta">
                                    created: ${created} • expires: ${expires}
                                </div>
                            </div>
                            <button class="danger" onclick="deleteApiKey('${key.id}')">delete</button>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                list.innerHTML = '<div class="loading">failed to load</div>';
            }
        }

        function showCreateKeyModal() {
            document.getElementById('createKeyModal').classList.add('active');
            setTimeout(() => document.getElementById('keyName').focus(), 100);
        }

        function closeModal() {
            document.getElementById('createKeyModal').classList.remove('active');
            document.getElementById('keyName').value = '';
            document.getElementById('keyExpiry').value = '';
        }

        async function createApiKey() {
            const name = document.getElementById('keyName').value;
            const expiresInDays = document.getElementById('keyExpiry').value;

            if (!name) {
                showStatus('enter a key name');
                return;
            }

            try {
                const response = await fetch('/api/keys', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        name,
                        expiresInDays: expiresInDays ? parseInt(expiresInDays) : null
                    })
                });

                if (!response.ok) {
                    throw new Error('failed to create api key');
                }

                const data = await response.json();
                document.getElementById('newApiKey').value = data.apiKey;
                closeModal();
                document.getElementById('keyCreatedModal').classList.add('active');
                setTimeout(() => document.getElementById('newApiKey').select(), 100);
                await loadApiKeys();
            } catch (error) {
                showStatus('failed to create key');
            }
        }

        function copyApiKey() {
            const input = document.getElementById('newApiKey');
            input.select();
            navigator.clipboard.writeText(input.value);
            showStatus('copied');
        }

        function closeKeyCreatedModal() {
            document.getElementById('keyCreatedModal').classList.remove('active');
            document.getElementById('newApiKey').value = '';
        }

        async function deleteApiKey(id) {
            if (!confirm('delete this api key?')) return;

            try {
                const response = await fetch(`/api/keys/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    showStatus('deleted');
                    await loadApiKeys();
                }
            } catch (error) {
                showStatus('delete failed');
            }
        }

        function logout() {
            fetch('/api/logout', {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${token}` }
            }).finally(() => {
                localStorage.removeItem('l4_token');
                window.location.href = '/login';
            });
        }

        init();
    </script>
</body>
</html>
